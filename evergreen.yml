variables:

functions:
  "fetch source" :
    - command: git.get_project
      type: system
      params:
        directory: src

  "merge in base branch":
    - command: shell.exec
      type: system
      params:
        working_dir: src
        shell: bash
        script: |
          set -vx
          # exit if non-patch or this is not a pull request
          if [[ "${is_patch}" != "true" || -z "${github_pr_number}" ]]; then
            exit 0
          fi

          # merge before checking
          git merge ${branch_name}

  "link":
    - command: shell.exec
      params:
        working_dir: src
        shell: bash
        script: |
          set -evx
          bin/ego link

  "install ops manager":
    - command: shell.exec
      params:
        working_dir: src
        shell: bash
        script: |
          set -evx
          bin/ego ops_manager_install_version --version ${version} --mongodb-version ${mongodb_version}

  "uninstall ops manager":
    - command: shell.exec
      params:
        working_dir: src
        shell: bash
        script: |
          set -evx
          bin/ego ops_manager_uninstall

  "clean":
    - command: shell.exec
      params:
        working_dir: src
        type: system
        shell: bash
        script: |
          echo "Outputting Ops Manager logs:"
          
          echo "==>"
          echo "==> mms-migration.log"
          cat /opt/mongodb/mms/logs/mms-migration.log

          echo "==>"
          echo "==> mms0-startup.log"
          cat /opt/mongodb/mms/logs/mms0-startup.log

          echo "==>"
          echo "==> daemon.log"
          cat /opt/mongodb/mms/logs/daemon.log

          echo "==>"
          echo "==> mms0.log"
          cat /opt/mongodb/mms/logs/mms0.log          

    - command: shell.exec
      params:
        working_dir: src
        type: system
        shell: bash
        script: |
          bin/ego ops_manager_clean

# Ensure the Evergreen host is clean
pre:
  - func: clean

# Leave nothing behind
post:
  - func: clean

tasks:
- name: Ops Manager 4.2
  tags:
    - install
  commands:
    - func: "fetch source"
    - func: "merge in base branch"
    - func: "link"
    - func: "install ops manager"
      vars:
        mongodb_version: 4.2.1
        version: 4.2.3
    - func: "uninstall ops manager"

buildvariants:
- name: ubuntu
  display_name: Ubuntu 18.04
  run_on:
  - ubuntu1804-build
  expansions:
  tasks:
  - name: .install
